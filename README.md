# Variational Bayes MRI Reconstruction with Structured Uncertainty Distributions 

## Overview
This repository contains code and data associated with the paper *Bayesian MRI Reconstruction with Structured Uncertainty Distributions*.

A pretrained structured uncertainty prediction network (SUPN) prior is provided in: 

```bash
supn_train/checkpoints/pretrained.pth
```

Alternatively this can be trained from scratch by running:
```bash
python supn_train/n_channel_train.py
``` 
This trains the model on 80% of the dataset for 600 epochs, saving a checkpoint every 100 epochs and storing copies of the models that achieve the lowest test and training likelihood.

Fitted posterior approximations for various example images are available in: 
```bash
post_estimation/checkpoints
```

Various samples from these distributions, along with the diffusion posterior sampler checkpoint and samples, are included to help visualise the results without retraining or resampling.

All visualisations from the paper and supplementary materials can be generated by running: 
```bash
post_estimation/visualise_*.py
```
Where `visualise_*.py` is one of the python scripts beginning `visualise_` in the `post_estimation` directory. Different scripts produce different figures and all can be run either from the repository base directory or from within the `post_estimation` directory. The resulting figures will be saved as PDF files in a `figures` directory (which will be created automatically if needed).

Reconstruction posteriors can also be fitted from scratch by running, for example:
```bash
python post_estimator.py --config recon_configs/config1
```

The configs `recon_configs/config{i}` for i = 1, 2, 3, ... each reconstruct an example image and mask size as shown in the paper. These can be edited to run alternative examples.

Experiment tracking is performed using Weights & Biases (W&B). This can be toggled off in the configuration (`supn_train_configs/fastMRI_complex_config`). Tracking is useful for online visualisation of training progress and reconstructions, but can be disabled if desired.


# Environment setup

The key dependency is the SUPN base class.

## SUPN_base class

The `supn_base` directory contains the classes and methods for working with structured uncertainty distributions. This is packaged as a PyTorch distribution with various properties and methods suitable for VAE training or other tasks.

The included version provides fast likelihood computation and sampling for multichannel images, sufficient for VAE training and visualisation. To use structured uncertainty distributions in your own project, you only need to modify your code to output the parameters of the distribution (the SUPN class defined in `supn_base/supn_distribution.py`). This class provides functionality similar to standard torch.distribution classes.

## Further requirements
Follow the installation procedure given in `supn_base/README.md` to install the SUPN base class. Once complete, install the additional dependencies: 

```bash
pip install matplotlib wandb configargparse toml tqdm 
```
